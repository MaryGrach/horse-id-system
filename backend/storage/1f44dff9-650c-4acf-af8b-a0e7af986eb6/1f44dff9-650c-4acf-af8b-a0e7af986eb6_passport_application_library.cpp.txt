#include <iostream>
#include <vector>
#include <algorithm>
#include <map>
#include <string>
#include <iomanip>

class Book {
private:
    int _id;
    std::string _title;
    std::string _author;
    int _totalCopies;
    int _availableCopies;

public:
    Book(int id, const std::string& title, const std::string& author, int totalCopies)
        : _id(id), _title(title), _author(author), _totalCopies(totalCopies), _availableCopies(totalCopies) {}

    int getId() const { return _id; }
    const std::string& getTitle() const { return _title; }
    const std::string& getAuthor() const { return _author; }
    int getTotalCopies() const { return _totalCopies; }
    int getAvailableCopies() const { return _availableCopies; }
    
    void borrowBook() { 
        if (_availableCopies > 0) _availableCopies--; 
    }
    
    void returnBook() { 
        if (_availableCopies < _totalCopies) _availableCopies++; 
    }
    
    bool isOutOfStock() const { return _availableCopies == 0; }
};

class LibraryLoanSystem {
private:
    std::map<int, std::vector<int>> _userLoans; 

public:
    void borrowBook(int userId, int bookId) {
        _userLoans[userId].push_back(bookId);
    }

    void returnBook(int userId, int bookId) {
        auto& userBooks = _userLoans[userId];
        userBooks.erase(std::remove(userBooks.begin(), userBooks.end(), bookId), userBooks.end());
    }

    const std::vector<int>& getBooksBorrowedByUser(int userId) const {
        static const std::vector<int> emptyVector;
        auto it = _userLoans.find(userId);
        if (it != _userLoans.end()) {
            return it->second;
        }
        return emptyVector;
    }

    const std::map<int, std::vector<int>>& getAllLoans() const {
        return _userLoans;
    }
};

class OutOfStockReportEngine {
private:
    const LibraryLoanSystem& _loanSystem;
    const std::vector<Book>& _books;

public:
    OutOfStockReportEngine(const LibraryLoanSystem& loanSystem, const std::vector<Book>& books)
        : _loanSystem(loanSystem), _books(books) {}

    std::vector<std::pair<int, int>> getOutOfStockReport() const {
        std::vector<std::pair<int, int>> report;
        
        std::map<int, int> bookBorrowStats; 
        
        for (const auto& userLoans : _loanSystem.getAllLoans()) {
            for (int bookId : userLoans.second) {
                bookBorrowStats[bookId]++;
            }
        }
        
        for (const auto& book : _books) {
            int bookId = book.getId();
            
            if (book.isOutOfStock() && bookBorrowStats.find(bookId) != bookBorrowStats.end()) {
                report.push_back({bookId, bookBorrowStats[bookId]});
            }
        }
        
        std::sort(report.begin(), report.end(),
                  [](const auto& a, const auto& b) { 
                      return a.second > b.second; 
                  });
        
        return report;
    }
};

class LibraryManager {
    std::vector<Book> _books;
    LibraryLoanSystem _loanSystem;

public:
    LibraryManager() {
        _books.push_back(Book(1, "Преступление и наказание", "Федор Достоевский", 3));
        _books.push_back(Book(2, "Война и мир", "Лев Толстой", 2));
        _books.push_back(Book(3, "Мастер и Маргарита", "Михаил Булгаков", 4));
        _books.push_back(Book(4, "1984", "Джордж Оруэлл", 2));
        _books.push_back(Book(5, "Гарри Поттер и философский камень", "Джоан Роулинг", 5));
        
        _loanSystem.borrowBook(1, 1); // Читатель 1 взял книгу 1
        _loanSystem.borrowBook(1, 2); // Читатель 1 взял книгу 2
        _loanSystem.borrowBook(2, 1); // Читатель 2 взял книгу 1
        _loanSystem.borrowBook(2, 3); // Читатель 2 взял книгу 3
        _loanSystem.borrowBook(3, 1); // Читатель 3 взял книгу 1
        _loanSystem.borrowBook(3, 4); // Читатель 3 взял книгу 4
        _loanSystem.borrowBook(4, 3); // Читатель 4 взял книгу 3
        
        for (auto& book : _books) {
            if (book.getId() == 1) {
                for (int i = 0; i < 3; i++) book.borrowBook(); 
            }
            if (book.getId() == 4) {
                book.borrowBook(); // Один экземпляр на руках
                book.borrowBook(); // Все экземпляры на руках
            }
        }
    }

    Book* findBookById(int id) {
        for (auto& book : _books) {
            if (book.getId() == id) {
                return &book;
            }
        }
        return nullptr;
    }

    void generateReport() {
        std::cout << "=== Отчет по книгам для заказа ===" << std::endl;
        std::cout << std::endl;

        std::cout << "Книги в библиотеке:" << std::endl;
        for (const auto& book : _books) {
            std::cout << book.getId() << ". " << book.getAuthor() 
                      << " - \"" << book.getTitle() << "\""
                      << " (Всего: " << book.getTotalCopies() 
                      << ", Доступно: " << book.getAvailableCopies() << ")" << std::endl;
        }
        std::cout << std::endl;

        OutOfStockReportEngine reportEngine(_loanSystem, _books);
        auto report = reportEngine.getOutOfStockReport();

        std::cout << "Книги для заказа (закончились в хранилище):" << std::endl;
        if (report.empty()) {
            std::cout << "  Нет книг для заказа - все книги в наличии" << std::endl;
        } else {
            for (size_t i = 0; i < report.size(); ++i) {
                auto book = findBookById(report[i].first);
                if (book) {
                    std::cout << "  " << (i + 1) << ". " << book->getAuthor() 
                              << " - \"" << book->getTitle() << "\""
                              << " (На руках у читателей: " << report[i].second 
                              << " экз.)" << std::endl;
                }
            }
        }
        std::cout << std::endl;

        std::cout << "Отчет показывает книги, которых нет в наличии, но которые пользуются спросом." << std::endl;
    }
};

int main() {
    LibraryManager library;
    library.generateReport();
    return 0;
}